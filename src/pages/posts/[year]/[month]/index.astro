---
import { getCollection } from 'astro:content';

import SubNavbar from '@/components/SubNavbar.astro';
import PostList from '@/components/post/List.astro';
import Layout from '@/layouts/Prose.astro';
import { loadAndFormatCollection } from '@/lib/utils.ts';

export async function getStaticPaths() {
  const posts = await loadAndFormatCollection('posts');
  return posts.map((post) => ({
    params: { year: post.data.year, month: post.data.month, slug: post.slug },
    props: post,
  }));
}

const pageTitle = 'Posts';
const pageDescription = 'Articles from makers in Roanoke.';
const params = Astro.params;

// TODO: refactor repetition for year/month (also in utils.js)
const posts = (await getCollection('posts'))
  .filter((p) => p.data.pubDate.getFullYear().toString() == params.year)
  .filter(
    (p) =>
      (p.data.pubDate.getMonth() + 1).toString().padStart(2, '0') ==
      params.month,
  )
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<Layout title={pageTitle} description={pageDescription}>
  <SubNavbar slot="subnav" links={[]} />

  <PostList posts={posts} />
</Layout>
