---
import SubNavbar from '@/components/SubNavbar.astro';
import PostList from '@/components/post/List.astro';
import type { NavbarConfig } from '@/components/schema';
import Layout from '@/layouts/Base.astro';
import { isNotNull, loadAndFormatCollection } from '@/lib/utils';
import type { CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const allPosts = await loadAndFormatCollection('posts');

  const uniqueTags = [
    ...new Set(allPosts.map((post) => post.data.tags).flat()),
  ];

  return uniqueTags.filter(isNotNull).map((tag: string) => {
    const filteredPosts = allPosts.filter((post) => {
      return (post.data.tags || []).includes(tag);
    });
    return {
      params: { tag },
      props: { posts: filteredPosts || [] },
    };
  });
}

interface Props {
  posts: CollectionEntry<'posts'>;
}
// type Props = CollectionEntry<'posts'>;

const tag = Astro.params;
const posts = Astro.props.posts;
// const { posts, tags } = Astro.props;

const subnav: NavbarConfig = {
  items: [],
};
---

<Layout title={tag} description={`Posts and events in ${tag}`}>
  <SubNavbar slot="subnav" sublist={subnav} />
  <PostList posts={posts} />
</Layout>
